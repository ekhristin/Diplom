name: Terraform

on:
  push:
    branches: [ main, master ]
    paths:
      - 'infrastructure/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'infrastructure/**'
  workflow_dispatch:

env:
  # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  # 'true' - —Ä–∞–∑–≤–µ—Ä—Çttesttest4—ã–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (terraform apply)
  # 'false' - —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (terraform destroy)
  UP_INF: 'false' # 'false'/'true'

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check deployment flag
        id: check_flag
        run: |
          UP_INF_VALUE="${{ env.UP_INF }}"
          if [ "$UP_INF_VALUE" = "true" ]; then
            echo "Deployment enabled: Up_inf = true (terraform apply)"
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "action=apply" >> $GITHUB_OUTPUT
          else
            echo "Deployment disabled: Up_inf = false (terraform destroy)"
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "action=destroy" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Configure Yandex Cloud credentials
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          mkdir -p ~/.config
          printf '%s\n' "$YC_SERVICE_ACCOUNT_KEY" > ~/.config/yc_sa_key.json
          chmod 600 ~/.config/yc_sa_key.json
          echo "YC_SERVICE_ACCOUNT_KEY_FILE=$HOME/.config/yc_sa_key.json" >> $GITHUB_ENV
      
      - name: Configure Terraform backend credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
      
      - name: Configure Terraform variables
        run: |
          # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ terraform.tfvars
          echo "TF_VAR_folder_id=${{ secrets.TF_VAR_folder_id }}" >> $GITHUB_ENV
          # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ variables.tf)
          if [ -n "${{ secrets.TF_VAR_cloud_id }}" ]; then
            echo "TF_VAR_cloud_id=${{ secrets.TF_VAR_cloud_id }}" >> $GITHUB_ENV
          fi
          if [ -n "${{ secrets.TF_VAR_environment }}" ]; then
            echo "TF_VAR_environment=${{ secrets.TF_VAR_environment }}" >> $GITHUB_ENV
          else
            echo "TF_VAR_environment=dev" >> $GITHUB_ENV
          fi
          if [ -n "${{ secrets.TF_VAR_project_name }}" ]; then
            echo "TF_VAR_project_name=${{ secrets.TF_VAR_project_name }}" >> $GITHUB_ENV
          else
            echo "TF_VAR_project_name=diplom" >> $GITHUB_ENV
          fi
          # service_account_key_file –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º –¥–ª—è CI/CD, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è YC_SERVICE_ACCOUNT_KEY_FILE
          echo "TF_VAR_service_account_key_file=" >> $GITHUB_ENV
      
      - name: Terraform Init
        working-directory: ./infrastructure
        run: terraform init
      
      - name: Terraform Validate
        if: steps.check_flag.outputs.action == 'apply'
        working-directory: ./infrastructure
        run: terraform validate
      
      - name: Terraform Plan
        if: steps.check_flag.outputs.action == 'apply'
        working-directory: ./infrastructure
        run: terraform plan -no-color
        continue-on-error: true
      
      - name: Terraform Apply
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        working-directory: ./infrastructure
        run: terraform apply -auto-approve -no-color
      
      - name: Get Kubernetes cluster information
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        id: k8s_info
        working-directory: ./infrastructure
        run: |
          CLUSTER_ID=$(terraform output -raw k8s_cluster_id)
          CLUSTER_NAME=$(terraform output -raw k8s_cluster_name)
          CLUSTER_ENDPOINT=$(terraform output -raw k8s_cluster_endpoint)
          echo "cluster_id=$CLUSTER_ID" >> $GITHUB_OUTPUT
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$CLUSTER_ENDPOINT" >> $GITHUB_OUTPUT
          echo "K8S_CLUSTER_ID=$CLUSTER_ID" >> $GITHUB_ENV
          echo "K8S_CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV
          echo "K8S_CLUSTER_ENDPOINT=$CLUSTER_ENDPOINT" >> $GITHUB_ENV
      
      - name: Setup kubectl
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Setup Yandex Cloud CLI
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Yandex Cloud CLI..."
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
          yc version
      
      - name: Configure Yandex Cloud CLI
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          yc config set service-account-key $HOME/.config/yc_sa_key.json
          yc config set folder-id ${{ secrets.TF_VAR_folder_id }}
      
      - name: Get kubeconfig
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          mkdir -p $HOME/.kube
          KUBECONFIG_PATH="$HOME/.kube/config"
          yc managed-kubernetes cluster get-credentials ${{ steps.k8s_info.outputs.cluster_id }} --external --kubeconfig "$KUBECONFIG_PATH"
          chmod 600 "$KUBECONFIG_PATH"
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º KUBECONFIG —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –ø—É—Ç–µ–º –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
          echo "KUBECONFIG=$KUBECONFIG_PATH" >> $GITHUB_ENV
          echo "‚úì Kubeconfig —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ $KUBECONFIG_PATH"
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
          if [ -f "$KUBECONFIG_PATH" ]; then
            echo "‚úì –§–∞–π–ª kubeconfig —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
            if [ -s "$KUBECONFIG_PATH" ]; then
              echo "‚úì –§–∞–π–ª kubeconfig —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ"
            else
              echo "::error::–§–∞–π–ª kubeconfig –ø—É—Å—Ç"
              exit 1
            fi
          else
            echo "::error::–§–∞–π–ª kubeconfig –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi
      
      - name: Verify Kubernetes connection
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä—É..."
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º KUBECONFIG —Å fallback
          if [ -z "$KUBECONFIG" ]; then
            export KUBECONFIG="$HOME/.kube/config"
          fi
          
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è KUBECONFIG: $KUBECONFIG"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
          if [ ! -f "$KUBECONFIG" ]; then
            echo "::error::–§–∞–π–ª kubeconfig –Ω–µ –Ω–∞–π–¥–µ–Ω: $KUBECONFIG"
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏..."
            if [ -f "$HOME/.kube/config" ]; then
              export KUBECONFIG="$HOME/.kube/config"
              echo "–ù–∞–π–¥–µ–Ω kubeconfig –≤ $HOME/.kube/config"
            else
              echo "::error::Kubeconfig –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏–∑ –æ–∂–∏–¥–∞–µ–º—ã—Ö –º–µ—Å—Ç"
              exit 1
            fi
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É..."
          kubectl cluster-info
          kubectl get nodes
          echo "‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
      
      
      - name: Setup Ingress Controller (nginx)
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          export KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
          echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ingress Controller (nginx)..."
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.11.1/deploy/static/provider/cloud/deploy.yaml
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Ingress Controller..."
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=300s || echo "Ingress Controller –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤"
          
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ IP –¥–ª—è Ingress Controller..."
          for i in {1..30}; do
            INGRESS_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$INGRESS_IP" ]; then
              echo "‚úì Ingress Controller –ø–æ–ª—É—á–∏–ª –≤–Ω–µ—à–Ω–∏–π IP: $INGRESS_IP"
              echo "INGRESS_IP=$INGRESS_IP" >> $GITHUB_ENV
              break
            fi
            echo "–û–∂–∏–¥–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ IP... ($i/30)"
            sleep 10
          done
          
          if [ -z "$INGRESS_IP" ]; then
            echo "‚ö†Ô∏è  –í–Ω–µ—à–Ω–∏–π IP –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
            kubectl describe service ingress-nginx-controller -n ingress-nginx | grep -A 10 "Events:" || echo "–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            echo ""
            echo "‚ö†Ô∏è  –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É PermissionDenied, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Service Account –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏–º–µ–µ—Ç —Ä–æ–ª—å 'editor' –≤ –ø–∞–ø–∫–µ"
            echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ: terraform apply –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ Service Account"
          fi
          
          echo "–°—Ç–∞—Ç—É—Å Ingress Controller:"
          kubectl get service ingress-nginx-controller -n ingress-nginx
          echo "‚úì Ingress Controller —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
      
      - name: Install kube-prometheus stack
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          export KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
          echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ kube-prometheus stack..."
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π kube-prometheus –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
          KUBE_PROMETHEUS_VERSION="v0.16.0"
          echo "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ kube-prometheus –≤–µ—Ä—Å–∏–∏ $KUBE_PROMETHEUS_VERSION..."
          git clone --depth 1 --branch $KUBE_PROMETHEUS_VERSION https://github.com/prometheus-operator/kube-prometheus.git /tmp/kube-prometheus || {
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é $KUBE_PROMETHEUS_VERSION, –∏—Å–ø–æ–ª—å–∑—É–µ–º main –≤–µ—Ç–∫—É..."
            git clone --depth 1 https://github.com/prometheus-operator/kube-prometheus.git /tmp/kube-prometheus
          }
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º setup –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã (CRDs –∏ namespace)
          echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ setup –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ (CRDs)..."
          kubectl apply --server-side -f /tmp/kube-prometheus/manifests/setup
          
          # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ CRDs
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ CRDs..."
          sleep 15
          kubectl wait \
            --for condition=Established \
            --all CustomResourceDefinition \
            --timeout=300s || echo "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ CRDs –º–æ–≥—É—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤—ã"
          
          # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
          echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤..."
          kubectl apply -f /tmp/kube-prometheus/manifests/
          
          echo "‚úì kube-prometheus stack —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
      
      - name: Wait for kube-prometheus components
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ kube-prometheus..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=grafana -n monitoring --timeout=300s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n monitoring --timeout=300s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=alertmanager -n monitoring --timeout=300s
          echo "‚úì –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã kube-prometheus –≥–æ—Ç–æ–≤—ã"
      
      - name: Setup Ingress for Grafana
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          export KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ingress –¥–ª—è Grafana..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å Grafana —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ Grafana..."
          kubectl get service grafana -n monitoring || echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å Grafana –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "–£–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Grafana –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º –ø—É—Ç–∏..."
          kubectl set env deployment/grafana -n monitoring GF_SERVER_SERVE_FROM_SUB_PATH- GF_SERVER_ROOT_URL- 2>/dev/null || echo "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω—ã"
          
          # –ñ–¥–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–æ–≤ Grafana –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
          if kubectl get deployment grafana -n monitoring &>/dev/null; then
            echo "–û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–æ–≤ Grafana..."
            sleep 10
            kubectl rollout status deployment/grafana -n monitoring --timeout=120s || echo "Grafana –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞"
          fi
          
          # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ Ingress, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –ø—É—Ç–µ–º "/"
          echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Ingress, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å..."
          kubectl delete ingress grafana-ingress -n monitoring 2>/dev/null || echo "Ingress –¥–ª—è Grafana –Ω–µ –Ω–∞–π–¥–µ–Ω"
          kubectl delete ingress app-test-web-ingress -n app-test-web 2>/dev/null || echo "Ingress –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          # –£–¥–∞–ª—è–µ–º NetworkPolicy –¥–ª—è Grafana, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –æ—Ç Ingress Controller
          # NetworkPolicy –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–∑–∂–µ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è
          echo "–£–¥–∞–ª–µ–Ω–∏–µ NetworkPolicy –¥–ª—è Grafana (–±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –æ—Ç Ingress Controller)..."
          kubectl delete networkpolicy grafana -n monitoring 2>/dev/null || echo "NetworkPolicy –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞"
          
          # –°–æ–∑–¥–∞–µ–º Ingress –¥–ª—è Grafana –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º –ø—É—Ç–∏ /
          echo "–°–æ–∑–¥–∞–Ω–∏–µ Ingress –¥–ª—è Grafana –Ω–∞ –ø—É—Ç–∏ /..."
          # –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º rewrite-target –¥–ª—è –ø—É—Ç–∏ /, —Ç–∞–∫ –∫–∞–∫ –ø—É—Ç—å —É–∂–µ –∫–æ—Ä–Ω–µ–≤–æ–π
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: grafana-ingress
            namespace: monitoring
            annotations:
              nginx.ingress.kubernetes.io/ssl-redirect: "false"
              nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
              nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
          spec:
            ingressClassName: nginx
            rules:
            - http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: grafana
                      port:
                        number: 3000
          EOF
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Ingress —Å–æ–∑–¥–∞–Ω
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Ingress..."
          kubectl get ingress grafana-ingress -n monitoring
          
          # –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP Ingress Controller –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
          INGRESS_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          if [ -z "$INGRESS_IP" ]; then
            CLUSTER_ENDPOINT="${{ steps.k8s_info.outputs.cluster_endpoint }}"
            INGRESS_IP=$(echo "$CLUSTER_ENDPOINT" | sed 's|https\?://||' | sed 's|:.*||')
          fi
          
          echo "‚úì Ingress –¥–ª—è Grafana –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://${INGRESS_IP}/"
      
      - name: Get Container Registry information
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        id: registry_info
        working-directory: ./infrastructure
        run: |
          REGISTRY_ID=$(terraform output -raw registry_id)
          REGISTRY_NAME=$(terraform output -raw registry_name)
          echo "registry_id=$REGISTRY_ID" >> $GITHUB_OUTPUT
          echo "registry_name=$REGISTRY_NAME" >> $GITHUB_OUTPUT
          echo "REGISTRY_ID=$REGISTRY_ID" >> $GITHUB_ENV
          echo "REGISTRY_NAME=$REGISTRY_NAME" >> $GITHUB_ENV
          echo "‚úì Container Registry ID: $REGISTRY_ID"
          echo "‚úì Container Registry Name: $REGISTRY_NAME"
      
      - name: Setup Docker Buildx
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
      
      - name: Authenticate to Yandex Container Registry
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Yandex Container Registry..."
          # –ü–æ–ª—É—á–∞–µ–º IAM —Ç–æ–∫–µ–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Docker
          IAM_TOKEN=$(yc iam create-token)
          echo "$IAM_TOKEN" | docker login --username iam --password-stdin cr.yandex
          echo "‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Container Registry –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
      
      - name: Build and push application image
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTPS –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          git clone https://github.com/ekhristin/app-test-web.git app-test-web || {
            echo "::error::–ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
            exit 1
          }
          cd app-test-web
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Dockerfile..."
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Dockerfile
          if [ ! -f "Dockerfile" ]; then
            echo "::warning::Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π Dockerfile..."
            echo "FROM nginx:alpine" > Dockerfile
            echo "COPY . /usr/share/nginx/html" >> Dockerfile
            echo "EXPOSE 80" >> Dockerfile
          fi
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –æ–±—Ä–∞–∑–∞ –¥–ª—è Yandex Container Registry
          IMAGE_NAME="cr.yandex/${{ steps.registry_info.outputs.registry_id }}/app-test-web:latest"
          echo "–°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞: $IMAGE_NAME"
          
          # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
          docker build -t $IMAGE_NAME .
          
          echo "–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ –≤ Yandex Container Registry..."
          docker push $IMAGE_NAME
          
          echo "‚úì –û–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Container Registry: $IMAGE_NAME"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
      
      - name: Create registry secret in Kubernetes
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "–°–æ–∑–¥–∞–Ω–∏–µ Secret –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Container Registry..."
          # –ü–æ–ª—É—á–∞–µ–º IAM —Ç–æ–∫–µ–Ω
          IAM_TOKEN=$(yc iam create-token)
          # –°–æ–∑–¥–∞–µ–º Docker config –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
          DOCKER_CONFIG=$(echo -n "iam:$IAM_TOKEN" | base64)
          # –°–æ–∑–¥–∞–µ–º Secret –≤ namespace app-test-web
          kubectl create namespace app-test-web --dry-run=client -o yaml | kubectl apply -f -
          kubectl create secret docker-registry yandex-registry-secret \
            --docker-server=cr.yandex \
            --docker-username=iam \
            --docker-password="$IAM_TOKEN" \
            --namespace=app-test-web \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "‚úì Secret –¥–ª—è Container Registry —Å–æ–∑–¥–∞–Ω"
      
      - name: Deploy application to Kubernetes
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          export KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
          echo "–î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Kubernetes..."
          
          # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Ingress –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
          echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Ingress –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
          kubectl delete ingress app-test-web-ingress -n app-test-web 2>/dev/null || echo "Ingress –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π"
          
          # –ò–º—è –æ–±—Ä–∞–∑–∞ –∏–∑ Container Registry
          IMAGE_NAME="cr.yandex/${{ steps.registry_info.outputs.registry_id }}/app-test-web:latest"
          
          # –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–±—Ä–∞–∑–∞ –∏–∑ Container Registry
          # –í–ê–ñ–ù–û: –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ app-test-web –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å nginx.conf
          # –ò–∑–º–µ–Ω–∏—Ç—å location /app –Ω–∞ location /app/ —Å alias –≤–º–µ—Å—Ç–æ root
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: app-test-web
            namespace: app-test-web
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: app-test-web
            template:
              metadata:
                labels:
                  app: app-test-web
              spec:
                imagePullSecrets:
                - name: yandex-registry-secret
                containers:
                - name: app-test-web
                  image: ${IMAGE_NAME}
                  ports:
                  - containerPort: 80
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: app-test-web
            namespace: app-test-web
          spec:
            type: ClusterIP
            selector:
              app: app-test-web
            ports:
            - port: 80
              targetPort: 80
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: app-test-web-ingress
            namespace: app-test-web
            annotations:
              nginx.ingress.kubernetes.io/ssl-redirect: "false"
              nginx.ingress.kubernetes.io/rewrite-target: /\$1
              nginx.ingress.kubernetes.io/use-regex: "true"
          spec:
            ingressClassName: nginx
            rules:
            - http:
                paths:
                - path: /app(.*)
                  pathType: ImplementationSpecific
                  backend:
                    service:
                      name: app-test-web
                      port:
                        number: 80
          EOF
          
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          kubectl wait --for=condition=available deployment/app-test-web -n app-test-web --timeout=300s || echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ"
          echo "‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Ingress –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Ingress –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          kubectl get ingress app-test-web-ingress -n app-test-web
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–µ–Ω
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          kubectl get service app-test-web -n app-test-web
          kubectl get endpoints app-test-web -n app-test-web
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          kubectl get pods -n app-test-web -l app=app-test-web
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –ø–æ–¥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫):"
          kubectl logs -n app-test-web -l app=app-test-web --tail=20 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Ingress Controller
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Ingress Controller..."
          kubectl get ingress --all-namespaces
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx –≤ Ingress Controller
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –≤ Ingress Controller..."
          INGRESS_POD=$(kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$INGRESS_POD" ]; then
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            kubectl exec -n ingress-nginx "$INGRESS_POD" -- cat /etc/nginx/nginx.conf | grep -A 10 "app-test-web" || echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è app-test-web –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –¥–ª—è Grafana:"
            kubectl exec -n ingress-nginx "$INGRESS_POD" -- cat /etc/nginx/nginx.conf | grep -A 10 "grafana" || echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è grafana –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          fi
      
      - name: Diagnostic information
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          export KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          echo ""
          echo "üìä –°—Ç–∞—Ç—É—Å Ingress Controller:"
          kubectl get service ingress-nginx-controller -n ingress-nginx
          INGRESS_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          if [ -z "$INGRESS_IP" ]; then
            echo "‚ö†Ô∏è  –í–Ω–µ—à–Ω–∏–π IP –¥–ª—è Ingress Controller –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"
            echo "   –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤ Yandex Cloud"
          else
            echo "‚úì –í–Ω–µ—à–Ω–∏–π IP Ingress Controller: $INGRESS_IP"
          fi
          
          echo ""
          echo "üìä –°—Ç–∞—Ç—É—Å Ingress —Ä–µ—Å—É—Ä—Å–æ–≤:"
          echo "Grafana Ingress:"
          kubectl get ingress grafana-ingress -n monitoring || echo "  Ingress –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo ""
          echo "Application Ingress:"
          kubectl get ingress app-test-web-ingress -n app-test-web || echo "  Ingress –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo ""
          echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
          echo "Grafana Service:"
          kubectl get service grafana -n monitoring || echo "  –°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo ""
          echo "Application Service:"
          kubectl get service app-test-web -n app-test-web || echo "  –°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo ""
          echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤:"
          echo "Grafana Pods:"
          kubectl get pods -n monitoring -l app.kubernetes.io/name=grafana || echo "  –ü–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          echo ""
          echo "Application Pods:"
          kubectl get pods -n app-test-web -l app=app-test-web || echo "  –ü–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      - name: Wait for Ingress to be ready
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          export KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Ingress Controller..."
          echo "‚ö†Ô∏è  –í Yandex Cloud –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ IP –¥–ª—è LoadBalancer –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 10-15 –º–∏–Ω—É—Ç"
          
          # –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ IP –¥–ª—è Ingress Controller (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è)
          INGRESS_IP=""
          MAX_ATTEMPTS=60  # 60 –ø–æ–ø—ã—Ç–æ–∫ = 10 –º–∏–Ω—É—Ç
          for i in $(seq 1 $MAX_ATTEMPTS); do
            INGRESS_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$INGRESS_IP" ] && [ "$INGRESS_IP" != "<pending>" ] && [ "$INGRESS_IP" != "null" ]; then
              echo "‚úì Ingress Controller –ø–æ–ª—É—á–∏–ª –≤–Ω–µ—à–Ω–∏–π IP: $INGRESS_IP"
              echo "INGRESS_IP=$INGRESS_IP" >> $GITHUB_ENV
              break
            fi
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 5 –ø–æ–ø—ã—Ç–æ–∫
            if [ $((i % 5)) -eq 0 ]; then
              echo "–û–∂–∏–¥–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ IP –¥–ª—è Ingress Controller... ($i/$MAX_ATTEMPTS)"
              echo "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
              kubectl get service ingress-nginx-controller -n ingress-nginx -o wide || true
            fi
            sleep 10
          done
          
          # –ï—Å–ª–∏ IP –≤—Å–µ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω, –≤—ã–≤–æ–¥–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
          if [ -z "$INGRESS_IP" ] || [ "$INGRESS_IP" == "<pending>" ] || [ "$INGRESS_IP" == "null" ]; then
            echo "‚ö†Ô∏è  –í–Ω–µ—à–Ω–∏–π IP –¥–ª—è LoadBalancer –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–æ—Å–ª–µ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫"
            echo "   –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è Yandex Cloud - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ IP –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 15-20 –º–∏–Ω—É—Ç"
            echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–æ–∑–∂–µ –∫–æ–º–∞–Ω–¥–æ–π:"
            echo "   kubectl get service ingress-nginx-controller -n ingress-nginx"
            echo ""
            echo "   –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥—Ä–µ—Å –∫–ª–∞—Å—Ç–µ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:"
            CLUSTER_ENDPOINT="${{ steps.k8s_info.outputs.cluster_endpoint }}"
            CLUSTER_HOST=$(echo "$CLUSTER_ENDPOINT" | sed 's|https\?://||' | sed 's|:.*||')
            echo "   –ê–¥—Ä–µ—Å –∫–ª–∞—Å—Ç–µ—Ä–∞: $CLUSTER_HOST"
            echo "INGRESS_IP=$CLUSTER_HOST" >> $GITHUB_ENV
          fi
      
      - name: Get deployment information and credentials
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        id: deployment_info
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          export KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
          echo "–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏..."
          
          # –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π IP LoadBalancer
          INGRESS_IP_CHECK=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          
          if [ -n "$INGRESS_IP_CHECK" ] && [ "$INGRESS_IP_CHECK" != "<pending>" ] && [ "$INGRESS_IP_CHECK" != "null" ]; then
            CLUSTER_HOST="$INGRESS_IP_CHECK"
            echo "‚úì –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω–∏–π IP LoadBalancer: $CLUSTER_HOST"
          elif [ -n "${{ env.INGRESS_IP }}" ]; then
            CLUSTER_HOST="${{ env.INGRESS_IP }}"
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–¥—Ä–µ—Å –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è: $CLUSTER_HOST"
          else
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥—Ä–µ—Å –∫–ª–∞—Å—Ç–µ—Ä–∞ –∫–∞–∫ fallback
            CLUSTER_ENDPOINT="${{ steps.k8s_info.outputs.cluster_endpoint }}"
            CLUSTER_HOST=$(echo "$CLUSTER_ENDPOINT" | sed 's|https\?://||' | sed 's|:.*||')
            echo "‚ö†Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–¥—Ä–µ—Å –∫–ª–∞—Å—Ç–µ—Ä–∞ (–≤–Ω–µ—à–Ω–∏–π IP LoadBalancer –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω): $CLUSTER_HOST"
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Grafana –∏–∑ Secret
          echo "–ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Grafana..."
          GRAFANA_USERNAME="admin"
          
          # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö Secret
          GRAFANA_PASSWORD=""
          
          # –í–∞—Ä–∏–∞–Ω—Ç 1: Secret —Å –∏–º–µ–Ω–µ–º grafana-admin
          GRAFANA_PASSWORD=$(kubectl get secret grafana-admin -n monitoring -o jsonpath='{.data.admin-password}' 2>/dev/null | base64 -d 2>/dev/null || echo "")
          
          # –í–∞—Ä–∏–∞–Ω—Ç 2: Secret —Å –º–µ—Ç–∫–æ–π app.kubernetes.io/name=grafana
          if [ -z "$GRAFANA_PASSWORD" ]; then
            GRAFANA_PASSWORD=$(kubectl get secret -n monitoring -l app.kubernetes.io/name=grafana -o jsonpath='{.items[0].data.admin-password}' 2>/dev/null | base64 -d 2>/dev/null || echo "")
          fi
          
          # –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—â–µ–º –ª—é–±–æ–π Secret –≤ namespace monitoring —Å admin-password
          if [ -z "$GRAFANA_PASSWORD" ]; then
            for secret in $(kubectl get secrets -n monitoring -o name 2>/dev/null); do
              GRAFANA_PASSWORD=$(kubectl get $secret -n monitoring -o jsonpath='{.data.admin-password}' 2>/dev/null | base64 -d 2>/dev/null || echo "")
              if [ -n "$GRAFANA_PASSWORD" ]; then
                break
              fi
            done
          fi
          
          # –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è kube-prometheus
          if [ -z "$GRAFANA_PASSWORD" ]; then
            GRAFANA_PASSWORD="admin"
            echo "‚ö†Ô∏è  –ü–∞—Ä–æ–ª—å Grafana –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Secrets, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: admin"
          else
            echo "‚úì –ü–∞—Ä–æ–ª—å Grafana —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏–∑ Secret"
          fi
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ (–≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ LoadBalancer, –±–µ–∑ NodePort)
          APP_URL="http://${CLUSTER_HOST}/app"
          GRAFANA_URL="http://${CLUSTER_HOST}/"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ outputs –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "grafana_url=$GRAFANA_URL" >> $GITHUB_OUTPUT
          echo "grafana_username=$GRAFANA_USERNAME" >> $GITHUB_OUTPUT
          echo "grafana_password=$GRAFANA_PASSWORD" >> $GITHUB_OUTPUT
          echo "cluster_host=$CLUSTER_HOST" >> $GITHUB_OUTPUT
      
      - name: Display deployment information
        if: steps.check_flag.outputs.action == 'apply' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë           –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û                     ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì± –ü–†–ò–õ–û–ñ–ï–ù–ò–ï"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞: ${{ steps.deployment_info.outputs.app_url }}"
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä GRAFANA"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞: ${{ steps.deployment_info.outputs.grafana_url }}"
          echo "üë§ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${{ steps.deployment_info.outputs.grafana_username }}"
          echo "üîë –ü–∞—Ä–æ–ª—å: ${{ steps.deployment_info.outputs.grafana_password }}"
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ÑπÔ∏è  –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üåê –ê–¥—Ä–µ—Å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞: ${{ steps.deployment_info.outputs.cluster_host }}"
          echo "üì¶ –ò–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞: ${{ steps.k8s_info.outputs.cluster_name }}"
          echo "üÜî ID –∫–ª–∞—Å—Ç–µ—Ä–∞: ${{ steps.k8s_info.outputs.cluster_id }}"
          echo ""
          INGRESS_IP_CHECK=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          INGRESS_TYPE=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.spec.type}' 2>/dev/null || echo "")
          
          echo "–¢–∏–ø —Å–µ—Ä–≤–∏—Å–∞ Ingress Controller: $INGRESS_TYPE"
          
          if [ -z "$INGRESS_IP_CHECK" ] || [ "$INGRESS_IP_CHECK" == "<pending>" ] || [ "$INGRESS_IP_CHECK" == "null" ]; then
            echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í–Ω–µ—à–Ω–∏–π IP –¥–ª—è LoadBalancer –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω."
            echo "   –í Yandex Cloud —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 15-20 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞."
            echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–æ–º–∞–Ω–¥–æ–π:"
            echo "   kubectl get service ingress-nginx-controller -n ingress-nginx"
            echo ""
            echo "   –ü–æ—Å–ª–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è IP, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
            echo "   http://<EXTERNAL-IP>/app"
            echo "   Grafana –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É:"
            echo "   http://<EXTERNAL-IP>/"
            echo ""
          else
            echo "‚úì –í–Ω–µ—à–Ω–∏–π IP LoadBalancer –Ω–∞–∑–Ω–∞—á–µ–Ω: $INGRESS_IP_CHECK"
          fi
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã!"
          echo ""
          
          # –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è GitHub Actions summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
          
          ## üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          
          **–°—Å—ã–ª–∫–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:** [${{ steps.deployment_info.outputs.app_url }}](${{ steps.deployment_info.outputs.app_url }})
          
          ## üìä Grafana
          
          **–°—Å—ã–ª–∫–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:** [${{ steps.deployment_info.outputs.grafana_url }}](${{ steps.deployment_info.outputs.grafana_url }})
          
          **–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
          - **–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** \`${{ steps.deployment_info.outputs.grafana_username }}\`
          - **–ü–∞—Ä–æ–ª—å:** \`${{ steps.deployment_info.outputs.grafana_password }}\`
          
          ## ‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          
          - **–ê–¥—Ä–µ—Å –∫–ª–∞—Å—Ç–µ—Ä–∞:** \`${{ steps.deployment_info.outputs.cluster_host }}\`
          - **–ò–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞:** \`${{ steps.k8s_info.outputs.cluster_name }}\`
          - **ID –∫–ª–∞—Å—Ç–µ—Ä–∞:** \`${{ steps.k8s_info.outputs.cluster_id }}\`
          
          ---
          
          ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!
          EOF
      
      - name: Get registry information for cleanup
        if: steps.check_flag.outputs.action == 'destroy' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        id: registry_cleanup_info
        working-directory: ./infrastructure
        run: |
          echo "–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Container Registry –¥–ª—è –æ—á–∏—Å—Ç–∫–∏..."
          REGISTRY_ID=$(terraform output -raw registry_id 2>/dev/null || echo "")
          REGISTRY_NAME=$(terraform output -raw registry_name 2>/dev/null || echo "")
          
          if [ -n "$REGISTRY_ID" ]; then
            echo "registry_id=$REGISTRY_ID" >> $GITHUB_OUTPUT
            echo "REGISTRY_ID=$REGISTRY_ID" >> $GITHUB_ENV
            echo "‚úì Container Registry ID: $REGISTRY_ID"
          fi
          
          if [ -n "$REGISTRY_NAME" ]; then
            echo "registry_name=$REGISTRY_NAME" >> $GITHUB_OUTPUT
            echo "REGISTRY_NAME=$REGISTRY_NAME" >> $GITHUB_ENV
            echo "‚úì Container Registry Name: $REGISTRY_NAME"
          fi
          
          if [ -z "$REGISTRY_ID" ] && [ -z "$REGISTRY_NAME" ]; then
            echo "‚ö†Ô∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Container Registry –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Terraform outputs"
            echo "   –í–æ–∑–º–æ–∂–Ω–æ, registry —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω"
          fi
      
      - name: Clean up Container Registry images
        if: steps.check_flag.outputs.action == 'destroy' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && steps.registry_cleanup_info.outputs.registry_id != ''
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "–û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –∏–∑ Container Registry –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º..."
          
          REGISTRY_ID="${{ steps.registry_cleanup_info.outputs.registry_id }}"
          
          if [ -z "$REGISTRY_ID" ]; then
            echo "‚ö†Ô∏è  Registry ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É"
            exit 0
          fi
          
          echo "–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –≤ registry: $REGISTRY_ID"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ –≤ registry
          IMAGES=$(yc container image list --registry-id "$REGISTRY_ID" --format json 2>/dev/null || echo "[]")
          
          if [ "$IMAGES" != "[]" ] && [ -n "$IMAGES" ]; then
            echo "–ù–∞–π–¥–µ–Ω–æ –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:"
            echo "$IMAGES" | jq -r '.[] | "  - \(.id)"' 2>/dev/null || echo "$IMAGES"
            
            # –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –æ–±—Ä–∞–∑
            if command -v jq &> /dev/null; then
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º jq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
              IMAGE_IDS=$(echo "$IMAGES" | jq -r '.[].id' | tr '\n' ' ')
              for image_id in $IMAGE_IDS; do
                if [ -n "$image_id" ] && [ "$image_id" != "null" ]; then
                  echo "–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞: $image_id"
                  yc container image delete "$image_id" --quiet 2>&1 || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑: $image_id"
                fi
              done
            else
              # –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ jq
              IMAGE_IDS=$(echo "$IMAGES" | grep -o '"id":"[^"]*"' | sed 's/"id":"\([^"]*\)"/\1/' | tr '\n' ' ')
              for image_id in $IMAGE_IDS; do
                if [ -n "$image_id" ]; then
                  echo "–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞: $image_id"
                  yc container image delete "$image_id" --quiet 2>&1 || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑: $image_id"
                fi
              done
            fi
            
            echo "‚úì –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          else
            echo "‚úì Registry –ø—É—Å—Ç, –æ–±—Ä–∞–∑—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
          fi
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–∑—ã –ø–æ –∏–º–µ–Ω–∏ registry
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ–±—Ä–∞–∑–æ–≤..."
          sleep 2
          REMAINING_IMAGES=$(yc container image list --registry-id "$REGISTRY_ID" --format json 2>/dev/null || echo "[]")
          if [ "$REMAINING_IMAGES" != "[]" ] && [ -n "$REMAINING_IMAGES" ]; then
            echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –æ–±—Ä–∞–∑—ã, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è..."
            if command -v jq &> /dev/null; then
              REMAINING_IDS=$(echo "$REMAINING_IMAGES" | jq -r '.[].id' | tr '\n' ' ')
              for image_id in $REMAINING_IDS; do
                if [ -n "$image_id" ] && [ "$image_id" != "null" ]; then
                  yc container image delete "$image_id" --quiet 2>&1 || true
                fi
              done
            fi
          fi
          
          echo "‚úì –û—á–∏—Å—Ç–∫–∞ Container Registry –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
      
      - name: Terraform Destroy
        if: steps.check_flag.outputs.action == 'destroy' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        working-directory: ./infrastructure
        run: terraform destroy -auto-approve -no-color
      
      - name: Infrastructure removal notice
        if: steps.check_flag.outputs.action == 'destroy' && (github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master')
        run: |
          echo "::warning::–£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (terraform destroy) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–æ–∫ main/master"
          echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: ${{ github.ref }}"
          echo "–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—ã–ø–æ–ª–Ω–∏—Ç–µ workflow –≤ –≤–µ—Ç–∫–µ main –∏–ª–∏ master"

